# HTTP接口

为了保证我们的客户端启动的足够快，我们故意避免了使用[Flare](https://github.com/Tencent/flare)来实现我们的客户端。

这儿主要的问题在于，Flare启动过程，为了进行必要的初始化，会引入数百毫秒的延迟。

通常而言，数百毫秒的启动延迟对于长期运行的服务并没有太大影响。但是对于我们的客户端来说，由于它对于每个编译任务会启动、退出一次，这个延迟是不可接受的。

因此，我们自行实现了一个简陋的HTTP客户端，通过HTTP协议和我们本地的编译守护进程进行交互。

这篇文档描述了我们的客户端和本地守护进程之间的接口。

## “分段”格式

我们在多个接口中使用“分段”格式。

这种格式第一行包含一系列通过逗号（`,`）隔开的十进制整数，对应每一个“分段”的长度。第一行以`\r\n`结束。

之后是所有分断的二进制连接起来的字节流。

如下为`{"XX", "0123456789"}`两段数据的二进制格式（为便于阅读加入空行，实际格式中不含空行）：

```text
2,10\r\n
XX0123456789
```

## 接口

除非额外说明，所有接口均需要使用`POST`方法请求。

我们所有对外提供的接口均包含一个Protocol Buffers消息的JSON表达，以及0个或多个字节流“附件”。

如果存在附件，则整个请求通过“分段”格式，其中第一段是请求的JSON表达，后续为附件。如果不存在附件，则整个请求为一个JSON表达（这时候不使用“分段”格式）。

具体的对外接口可参考[`messages.proto`](messages.proto)：

- `HttpService`定义的注释中说明了各个接口的URI。
- 各个接口的相关消息定义了实际需要传递的JSON表达的格式。

## 其他

需要特别注意的是，对于Protocol Buffers消息中的`int64` / `uint64`字段，[在JSON中需要作为字符串（而不是整形）传递](https://developers.google.com/protocol-buffers/docs/proto3#json)。
